# Coolify Deployment Guide for Omarchy Directory

This guide explains how to deploy the Omarchy Directory application using Coolify.

## Prerequisites

1. A Coolify instance running (self-hosted or cloud)
2. A domain name configured in Coolify
3. Git repository access (GitHub, GitLab, etc.)

## Deployment Steps

### 1. Create New Application in Coolify

1. Log into your Coolify dashboard
2. Click "New Application"
3. Select "Docker Compose" as the build pack
4. Connect your Git repository
5. Set the branch to `main` (or your preferred branch)

### 2. Configure Environment Variables

Coolify will automatically detect the following environment variables from the compose file:

#### Required Variables (Auto-generated by Coolify):
- `SERVICE_URL_POSTGRES` - PostgreSQL connection URL
- `SERVICE_URL_REDIS` - Redis connection URL  
- `SERVICE_PASSWORD_POSTGRES` - PostgreSQL password
- `SERVICE_PASSWORD_REDIS` - Redis password
- `SERVICE_PASSWORD_SECRET_KEY` - Rails secret key base
- `SERVICE_PASSWORD_ADMIN` - Admin password for the application
- `SERVICE_FQDN_WEB` - Application domain name

#### Optional Variables (Set manually):
- `SMTP_HOST` - Email server hostname
- `SMTP_PORT` - Email server port
- `SMTP_USERNAME` - Email username
- `SMTP_PASSWORD` - Email password
- `SENTRY_DSN` - Error tracking service
- `NEW_RELIC_LICENSE_KEY` - Application monitoring

### 3. Configure Domain

1. In the application settings, go to "Domains"
2. Add your domain (e.g., `omarchy.app`)
3. Coolify will automatically handle SSL certificates via Let's Encrypt

### 4. Storage Configuration

The compose file includes persistent storage for:
- PostgreSQL data (`postgres_data`)
- Redis data (`redis_data`) 
- Application logs (`app_logs`)
- Application temporary files (`app_data`)

### 5. Deploy

1. Click "Deploy" in Coolify
2. Monitor the deployment logs
3. The application will be available at your configured domain

## Coolify Magic Variables Explained

Based on the [Coolify documentation](https://coolify.io/docs/knowledge-base/docker/compose), the following magic variables are used:

### Service URLs
- `SERVICE_URL_POSTGRES` - Generates PostgreSQL connection URL
- `SERVICE_URL_REDIS` - Generates Redis connection URL
- `SERVICE_FQDN_WEB` - Generates the application domain name

### Service Passwords
- `SERVICE_PASSWORD_POSTGRES` - Generates secure PostgreSQL password
- `SERVICE_PASSWORD_REDIS` - Generates secure Redis password
- `SERVICE_PASSWORD_SECRET_KEY` - Generates Rails secret key base
- `SERVICE_PASSWORD_ADMIN` - Generates admin password for the application

### Service Labels

The compose file includes Coolify-specific labels:

```yaml
labels:
  - traefik.enable=true
  - "traefik.http.routers.web.rule=Host(`${SERVICE_FQDN_WEB}`)"
  - traefik.http.routers.web.entrypoints=http
  - traefik.http.routers.web.entrypoints=https
  - traefik.http.services.web.loadbalancer.server.port=3000
```

These labels configure Traefik (Coolify's proxy) to:
- Enable the service for external access
- Route traffic based on the domain name
- Handle both HTTP and HTTPS traffic
- Load balance to port 3000

## Database Services

The PostgreSQL and Redis services are marked with Coolify labels:

```yaml
labels:
  - coolify.managed=true
  - coolify.type=database  # or cache for Redis
```

This tells Coolify to manage these as internal services that don't need external access.

## Health Checks

Coolify will automatically perform health checks on the web service. The application includes a health check endpoint at `/health` that returns a simple "healthy" response.

## Monitoring and Logs

- **Logs**: Available in the Coolify dashboard under "Logs"
- **Metrics**: Basic metrics available in the dashboard
- **Health**: Service health status visible in the dashboard

## Backup and Maintenance

### Database Backups
Coolify can be configured to automatically backup the PostgreSQL database. Configure this in the database service settings.

### Application Updates
To update the application:
1. Push changes to your Git repository
2. Click "Deploy" in Coolify
3. Coolify will rebuild and redeploy automatically

## Security Considerations

1. **Admin Password**: Change the auto-generated admin password after first deployment
2. **Database Access**: PostgreSQL is only accessible within the Docker network
3. **SSL/TLS**: Automatically handled by Coolify via Let's Encrypt
4. **Firewall**: Configure server firewall to only allow necessary ports

## Troubleshooting

### Common Issues

1. **Build Failures**: Check the build logs in Coolify dashboard
2. **Database Connection**: Verify PostgreSQL service is running
3. **Domain Issues**: Ensure DNS is properly configured
4. **SSL Certificate**: Let's Encrypt certificates are automatically managed

### Useful Commands

Access the application container for debugging:
```bash
# Via Coolify terminal or SSH
docker exec -it <container_name> bash
```

Check service status:
```bash
docker ps
docker logs <container_name>
```

## Production Checklist

- [ ] Domain configured and DNS pointing to Coolify server
- [ ] SSL certificate automatically provisioned
- [ ] Admin password changed from auto-generated value
- [ ] Database backups configured
- [ ] Monitoring set up (optional)
- [ ] Error tracking configured (optional)
- [ ] Email notifications set up (optional)

## Support

For Coolify-specific issues, refer to the [Coolify documentation](https://coolify.io/docs/knowledge-base/docker/compose) or the Coolify community support channels.

